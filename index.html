<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart City San Isidro - Gesti√≥n de Residuos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary: #1a2a6c;
            --vacio: #2ecc71;
            --mitad: #f1c40f;
            --lleno: #e74c3c;
            --bg: #f4f7f6;
            --text: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        header { text-align: center; margin-bottom: 20px; }
        
        #map-container { position: relative; width: 100%; margin-bottom: 20px; }
        #map { 
            height: 450px; width: 100%; border-radius: 15px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 2px solid white;
            z-index: 1; transition: height 0.4s ease;
        }
        #map.map-small { height: 300px; }

        #legend {
            position: absolute; top: 10px; right: 10px;
            background: white; padding: 10px; border-radius: 8px;
            z-index: 1000; font-size: 0.8em; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); text-align: center; }
        .value { font-size: 2.5em; font-weight: bold; margin: 5px 0; }
        .unit { font-size: 0.4em; color: #888; }
        
        .status-container { padding: 8px; border-radius: 10px; font-weight: bold; color: white; margin-top: 10px; }
        
        #historyChart { background: white; border-radius: 15px; padding: 15px; margin-top: 20px; display: none; }
        
        #route-btn {
            padding: 12px 20px; background: #27ae60; color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px;
        }
        .order-label {
            background: var(--primary); color: white; border-radius: 50%;
            width: 22px; height: 22px; display: flex; align-items: center;
            justify-content: center; font-size: 11px; border: 2px solid white;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Smart City - San Isidro</h1>
        <button id="route-btn" onclick="gestionarRecogida()">Trazar Ruta de Recogida</button>
        <div id="km-display" style="display:none; font-weight:bold;">üìç Distancia: <span id="km-val">0</span> km</div>
    </header>

    <div id="map-container">
        <div id="map"></div>
        <div id="legend">
            <div class="legend-item"><span class="dot" style="background:var(--vacio)"></span> Vac√≠o (< 50%)</div>
            <div class="legend-item"><span class="dot" style="background:var(--mitad)"></span> Mitad (50-89%)</div>
            <div class="legend-item"><span class="dot" style="background:var(--lleno)"></span> Lleno (‚â• 90%)</div>
        </div>
    </div>

    <div id="dashboard" class="grid" style="display: none;">
        <div class="card">
            <div id="cont-name" style="color: #666; font-weight: bold;">Selecciona un contenedor</div>
            <div id="v-count" class="value">0<span class="unit">L</span></div>
            <div id="status-text" class="status-container">OK</div>
        </div>
        <div class="card">
            <div style="color: #666; font-weight: bold;">Temperatura</div>
            <div id="v-temp" class="value">0<span class="unit">¬∞C</span></div>
            <div id="t-status" class="status-container" style="background: #eee; color: #333;">Normal</div>
        </div>
    </div>
    
    <canvas id="historyChart"></canvas>
</div>

<script>
    const BASE_URL = window.location.origin;
    let myChart = null;
    let selectedName = null;
    let markers = {};
    let modoRecogida = false;
    let rutaLayers = [];

    const map = L.map('map').setView([38.1730, -0.8385], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const redContenedores = [
        {pos: [38.173479, -0.835883], t: "Ronda del Amor", isReal: false},
        {pos: [38.173960, -0.836779], t: "Ronda Palmeras", isReal: false},
        {pos: [38.172770, -0.837985], t: "Calle Palmeras", isReal: false},
        {pos: [38.172698, -0.839877], t: "Calle Paz", isReal: false},
        {pos: [38.173453, -0.841170], t: "Calle Pedro Lopez", isReal: false},
        {pos: [38.171267, -0.841719], t: "Calle Jos√© Antonio Cutillas", isReal: false},
        {pos: [38.169428, -0.844210], t: "Calle la Huerta", isReal: false},
        {pos: [38.168953, -0.839716], t: "Avenida de Catral", isReal: false},
        {pos: [38.170535, -0.838425], t: "Calle del agua", isReal: true}
    ];

    // Inicializar marcadores
    redContenedores.forEach(c => {
        const m = L.marker(c.pos).addTo(map);
        m.on('click', () => selectContainer(c.t));
        markers[c.t] = m;
    });

    async function fetchData() {
        try {
            const res = await fetch(`${BASE_URL}/latest-data`);
            const data = await res.json();

            redContenedores.forEach(c => {
                let weight, temp, history;
                
                if (c.isReal) {
                    weight = data.global.count;
                    temp = data.global.temperature;
                    history = data.global.history;
                } else {
                    const d = data.simulados[c.t];
                    weight = d.current_weight;
                    temp = d.current_temp;
                    history = d.history;
                }

                // Actualizar Icono en Mapa
                let color = weight >= 90 ? 'red' : (weight >= 50 ? 'gold' : 'green');
                if (temp > 45) color = 'orange'; // Simulaci√≥n de calor/fuego
                
                markers[c.t].setIcon(L.icon({
                    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                    iconSize: [25, 41], iconAnchor: [12, 41]
                }));

                // Si es el seleccionado, actualizar UI
                if (c.t === selectedName) {
                    document.getElementById('v-count').innerHTML = `${weight.toFixed(0)}<span class="unit">L</span>`;
                    document.getElementById('v-temp').innerHTML = `${temp.toFixed(1)}<span class="unit">¬∞C</span>`;
                    
                    const sText = document.getElementById('status-text');
                    sText.innerText = weight >= 90 ? "LLENO" : (weight >= 50 ? "MITAD" : "VAC√çO");
                    sText.style.background = weight >= 90 ? "var(--lleno)" : (weight >= 50 ? "var(--mitad)" : "var(--vacio)");
                    
                    updateChart(history);
                }
            });
        } catch (e) { console.error("Error update:", e); }
    }

    function selectContainer(name) {
        selectedName = name;
        document.getElementById('cont-name').innerText = name;
        document.getElementById('map').classList.add('map-small');
        document.getElementById('dashboard').style.display = 'grid';
        document.getElementById('historyChart').style.display = 'block';
        setTimeout(() => map.invalidateSize(), 400);
        initChart();
        fetchData();
    }

    function initChart() {
        if (myChart) return;
        myChart = new Chart(document.getElementById('historyChart'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Nivel de Basura (L)', data: [], borderColor: '#1a2a6c', backgroundColor: 'rgba(26, 42, 108, 0.1)', fill: true, tension: 0.1 }] },
            options: { responsive: true, scales: { y: { min: 0, max: 100 } }, animation: false }
        });
    }

    function updateChart(history) {
        if (!myChart || !history) return;
        myChart.data.labels = history.map(h => h.timestamp);
        myChart.data.datasets[0].data = history.map(h => h.weight);
        myChart.update('none');
    }

    async function gestionarRecogida() {
        if (modoRecogida) {
            if (confirm("¬øVaciar contenedores seleccionados?")) {
                // Aqu√≠ podr√≠as enviar el POST de vaciado
                alert("Ruta completada. Contenedores vaciados.");
                location.reload();
            }
            return;
        }
        alert("Calculando ruta √≥ptima para contenedores llenos...");
        // L√≥gica de ruta simplificada para el ejemplo
        document.getElementById('km-display').style.display = 'block';
        document.getElementById('km-val').innerText = "2.4";
        document.getElementById('route-btn').innerText = "üèÅ Finalizar Recogida";
        modoRecogida = true;
    }

    setInterval(fetchData, 2000);
</script>
</body>
</html>
