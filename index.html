<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Recogida de Basuras Inteligente - San Isidro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary: #1a2a6c;
            --vacio: #2ecc71;
            --mitad: #f1c40f;
            --lleno: #e74c3c;
            --bg: #f4f7f6;
            --text: #333;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        header { text-align: center; margin-bottom: 30px; }
        #map-container { position: relative; width: 100%; margin-bottom: 25px; }
        #map { 
            height: 480px; width: 100%; border-radius: 15px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 2px solid white;
            z-index: 1; transition: height 0.5s ease-in-out;
        }
        #map.map-expanded { height: 650px; }
        #legend {
            position: absolute; top: 80px; left: 10px;
            background: rgba(255, 255, 255, 0.95); padding: 10px 15px;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            z-index: 1000; font-size: 0.9em; border: 1px solid #ddd;
        }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-weight: 600; }
        .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); text-align: center; }
        .value { font-size: 3em; font-weight: bold; margin: 10px 0; transition: color 0.3s; }
        .unit { font-size: 0.4em; color: #888; margin-left: 5px; }
        .status-container { margin-top: 15px; padding: 10px; border-radius: 20px; font-size: 0.9em; font-weight: bold; color: white; transition: all 0.3s; }
        .dashboard-content { display: none; margin-top: 20px; }
        .order-label {
            background: var(--primary); color: #fff; border-radius: 50%;
            width: 24px !important; height: 24px !important;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 12px;
        }
        #route-btn {
            padding: 12px 25px; background: #27ae60; color: white;
            border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; font-size: 1rem; margin-top: 15px;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #km-display {
            margin-top: 10px; font-weight: bold; color: var(--primary);
            display: none; font-size: 1.1em;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Sistema de Recogida de Basura Inteligente-San Isidro</h1>
        <button id="route-btn" onclick="gestionarRecogida()"> Trazar Ruta Eficiente</button>
        <div id="km-display">üìç Distancia total: <span id="km-val">0</span> km</div>
    </header>

    <div id="map-container">
        <div id="map" class="map-expanded"></div>
        <div id="legend">
            <div class="legend-item"><span class="dot" style="background:var(--vacio)"></span> Vacio </div>
            <div class="legend-item"><span class="dot" style="background:var(--mitad)"></span> Mitad </div>
            <div class="legend-item"><span class="dot" style="background:var(--lleno)"></span> Lleno </div>
            <div class="legend-item">
                <img src="https://cdn-icons-png.flaticon.com/512/2271/2271068.png" style="width:18px; height:18px;"> 
                Nave Industrial
            </div>
            <div class="legend-item">
                <img src="https://cdn-icons-png.flaticon.com/512/426/426833.png" style="width:16px; height:16px;"> 
                Fuego
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="dashboard-content">
        <div class="grid">
            <div class="card">
                <div id="container-title" class="label" style="font-weight: bold; color: #666;">Contenedor</div>
                <div id="v-count" class="value">0<span class="unit">L</span></div>
                <div id="status-text" class="status-container">Cargando...</div>
            </div>
            <div class="card">
                <div class="label" style="font-weight: bold; color: #666;">Temperatura</div>
                <div id="v-temp" class="value">0<span class="unit">¬∞C</span></div>
                <div id="t-temp" class="status-container" style="color:#333; background:#eee;">Sensor Activo</div>
            </div>
        </div>
        <canvas id="historyChart" height="100"></canvas>
    </div>
</div>

<script>
    const BASE_URL = window.location.origin;
    let myChart;
    let selectedContainerName = null;
    let lastUpdateTimestamp = null;
    let modoRecogida = false;
    let elementosRuta = []; 
    let contenedoresEnRuta = []; // Nueva variable para el reset selectivo
    const ctx = document.getElementById('historyChart').getContext('2d');

    const COORD_NAVE = [38.176611, -0.838111];

    const map = L.map('map').setView([38.1730, -0.8385], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    L.marker(COORD_NAVE, {
        icon: L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/2271/2271068.png',
            iconSize: [35, 35], iconAnchor: [17, 35]
        })
    }).addTo(map).bindPopup("<b>Base Log√≠stica: Nave Pol√≠gono</b>");

    const iconsMap = {
        verde: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        amarillo: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
        rojo: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        fuego: 'https://cdn-icons-png.flaticon.com/512/426/426833.png'
    };
    
    const shadowUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png';

    const redContenedores = [
        {pos: [38.173479, -0.835883], t: "Ronda del Amor", isReal: false},
        {pos: [38.173960, -0.836779], t: "Ronda Palmeras", isReal: false},
        {pos: [38.172770, -0.837985], t: "Calle Palmeras", isReal: false},
        {pos: [38.172698, -0.839877], t: "Calle Paz", isReal: false},
        {pos: [38.173453, -0.841170], t: "Calle Pedro Lopez", isReal: false},
        {pos: [38.171267, -0.841719], t: "Calle Jos√© Antonio Cutillas", isReal: false},
        {pos: [38.169428, -0.844210], t: "Calle la Huerta", isReal: false},
        {pos: [38.168953, -0.839716], t: "Avenida de Catral", isReal: false},
        {pos: [38.170535, -0.838425], t: "Calle del agua", isReal: true}
    ];

    const markers = {};

    function getStatusData(weight) {
        if (weight >= 90) return { label: "LLENO", color: "var(--lleno)", key: "rojo" };
        if (weight >= 50) return { label: "MITAD", color: "var(--mitad)", key: "amarillo" };
        return { label: "VACIO", color: "var(--vacio)", key: "verde" };
    }

    redContenedores.forEach((c) => {
        const m = L.marker(c.pos, {
            icon: L.icon({ 
                iconUrl: iconsMap.verde, shadowUrl: shadowUrl,
                iconSize: [25, 41], iconAnchor: [12, 41]
            })
        }).addTo(map);
        m.on('click', (e) => { L.DomEvent.stopPropagation(e); onContainerClick(c.t); });
        markers[c.t] = m;
    });

    fetchData();
    setInterval(fetchData, 1000);

    map.on('click', function() { resetToInitialState(); });

    function resetToInitialState() {
        selectedContainerName = null;
        lastUpdateTimestamp = null;
        document.getElementById('map').classList.add('map-expanded');
        document.getElementById('main-dashboard').style.display = 'none';
        setTimeout(() => { map.invalidateSize(); map.setView([38.1730, -0.8385], 16); }, 550);
    }

    function onContainerClick(name) {
        selectedContainerName = name;
        lastUpdateTimestamp = null;
        document.getElementById('map').classList.remove('map-expanded');
        setTimeout(() => map.invalidateSize(), 550);
        document.getElementById('main-dashboard').style.display = 'block';
        document.getElementById('container-title').innerText = "Contenedor: " + name;
        initChart(); 
        fetchData(); 
    }

    async function gestionarRecogida() {
        const btn = document.getElementById('route-btn');
        
        // --- L√ìGICA DE VACIADO SELECTIVO ---
        if (modoRecogida) { 
            if(confirm("¬øConfirmar vaciado de los contenedores recogidos?")) {
                try {
                    const res = await fetch(`${BASE_URL}/reset`, { 
                        method: 'POST',
                        headers: { 
                            'ngrok-skip-browser-warning': 'true',
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({ contenedores: contenedoresEnRuta })
                    });
                    if (res.ok) {
                        alert("Contenedores vaciados correctamente.");
                        location.reload(); 
                    }
                } catch (e) {
                    alert("Error al conectar con el servidor para vaciar.");
                }
            }
            return; 
        }

        // --- L√ìGICA DE TRAZADO DE RUTA ---
        const cr√≠ticos = redContenedores.filter(c => {
            const currentIcon = markers[c.t].options.icon.options.iconUrl;
            return currentIcon.includes('red') || currentIcon.includes('426833');
        });

        if (cr√≠ticos.length === 0) { 
            alert("No hay contenedores cr√≠ticos."); 
            return; 
        }

        // Guardamos los nombres para el vaciado posterior
        contenedoresEnRuta = cr√≠ticos.map(c => c.t);

        let coordsArr = [[COORD_NAVE[1], COORD_NAVE[0]]];
        cr√≠ticos.forEach(c => coordsArr.push([c.pos[1], c.pos[0]]));
        coordsArr.push([COORD_NAVE[1], COORD_NAVE[0]]);

        const coordsStr = coordsArr.map(c => c[0] + "," + c[1]).join(';');
        const url = `https://router.project-osrm.org/route/v1/driving/${coordsStr}?overview=full&geometries=geojson`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.code === 'Ok') {
                elementosRuta.forEach(el => map.removeLayer(el));
                elementosRuta = [];

                const route = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                const polyline = L.polyline(route, { color: '#1a2a6c', weight: 6, opacity: 0.8 }).addTo(map);
                elementosRuta.push(polyline);

                cr√≠ticos.forEach((c, index) => {
                    const label = L.marker(c.pos, {
                        icon: L.divIcon({ className: 'order-label', html: index + 1, iconAnchor: [12, 12] }),
                        interactive: false
                    }).addTo(map);
                    elementosRuta.push(label);
                });

                document.getElementById('km-val').innerText = (data.routes[0].distance / 1000).toFixed(2);
                document.getElementById('km-display').style.display = 'block';
                btn.innerText = "üèÅ Confirmar Vaciado de Ruta";
                btn.style.background = "#e74c3c";
                modoRecogida = true;
                map.fitBounds(polyline.getBounds(), {padding: [50, 50]});
            }
        } catch (e) {
            alert("Error al trazar la ruta.");
        }
    }

    async function fetchData() {
        try {
            const response = await fetch(`${BASE_URL}/latest-data`, { headers: { 'ngrok-skip-browser-warning': 'true' } });
            const data = await response.json();
            redContenedores.forEach(c => {
                let w = c.isReal ? data.global.count : data.simulados[c.t].current_weight;
                let t = c.isReal ? data.global.temperature : data.simulados[c.t].current_temp;
                const state = getStatusData(w);
                
                let iconUrl = t >= 40 ? iconsMap.fuego : iconsMap[state.key];
                markers[c.t].setIcon(L.icon({
                    iconUrl: iconUrl, shadowUrl: t >= 40 ? null : shadowUrl,
                    iconSize: t >= 40 ? [35, 35] : [25, 41], iconAnchor: t >= 40 ? [17, 17] : [12, 41]
                }));

                if (c.t === selectedContainerName) {
                    document.getElementById('v-count').innerHTML = w.toFixed(1) + '<span class="unit">L</span>';
                    document.getElementById('v-temp').innerHTML = t.toFixed(1) + '<span class="unit">¬∞C</span>';
                    const sBox = document.getElementById('status-text');
                    const tBox = document.getElementById('t-temp');
                    
                    if (t >= 40) {
                        tBox.innerText = "üî• ¬°ALERTA FUEGO!"; tBox.style.background = "#000"; tBox.style.color = "#e74c3c";
                    } else {
                        tBox.innerText = "Sensor Activo"; tBox.style.background = "#eee"; tBox.style.color = "#333";
                    }
                    sBox.innerText = `ESTADO: ${state.label}`;
                    sBox.style.background = state.color;
                    updateChart(c.isReal ? data.global.history : data.simulados[c.t].history);
                }
            });
        } catch (e) { }
    }

    function updateChart(historyData) {
        if (!myChart || !historyData.length) return;
        const lastPoint = historyData[historyData.length - 1];
        if (lastPoint.timestamp !== lastUpdateTimestamp) {
            lastUpdateTimestamp = lastPoint.timestamp;
            myChart.data.labels = historyData.map(p => p.timestamp);
            myChart.data.datasets[0].data = historyData.map(p => p.weight);
            myChart.update('none');
        }
    }

    function initChart() {
        if (myChart) return;
        myChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Nivel (L)', data: [], borderColor: '#1a2a6c', tension: 0.4, fill: true, backgroundColor: 'rgba(26, 42, 108, 0.1)' }] },
            options: { responsive: true, animation: false, scales: { y: { beginAtZero: true, max: 105 } } }
        });
    }
</script>
</body>
</html>
